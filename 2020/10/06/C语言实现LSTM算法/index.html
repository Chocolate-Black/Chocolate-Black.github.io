<!DOCTYPE html>
<html 
	lang="zh">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		
<link rel="stylesheet" href="/css/layout.css">

		
		<title> C语言实现LSTM算法 -  Blog</title>
		<link rel="stylesheet" href="https://unpkg.com/mdui@1.0.2/dist/css/mdui.min.css" />
		<script src="https://unpkg.com/mdui@1.0.2/dist/js/mdui.min.js"></script>
		<!-- lazyload -->
		<script src="https://unpkg.com/lazysizes@5.1.0/lazysizes.min.js"></script>
		<!-- smooth-scrolling -->
		<script src="https://unpkg.com/smooth-scrolling.js@1.0.0"></script>
		<!-- highlight -->
		<link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.6.0/styles/atom-one-dark.min.css" />
		<script src="//unpkg.com/@highlightjs/cdn-assets@11.6.0/highlight.min.js"></script>
		<!-- 预置 kiraicon -->
		<link rel="stylesheet" href="/lib/iconfont/iconfont.css" crossorigin />
		
			<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3299330_2a7ov96q7e3.css" crossorigin />
		
		<link rel="stylesheet" href="/lib/iconfont/iconfont.css" crossorigin />
		<link
			rel="shortcut icon"
			href="https://cdn.jsdelivr.net/gh/Chocolate-Black/pictureCDN/img/new_ava.png"
			type="image/png"
		/>
		<link rel="stylesheet" href="/deps/css/APlayer.min.css">
		
			
		<link rel="stylesheet" href="/style.css" />
			
		<link rel="stylesheet" href="/custom.css" />
			
		
		<script src="/deps/js/APlayer.min.js"></script>
		<script src="/deps/js/Meting.min.js"></script>
	<meta name="generator" content="Hexo 6.3.0"></head>

	<body>
		<div
			class="kira-background"
			style="background-image: url('https://cdn.jsdelivr.net/gh/Chocolate-Black/pictureCDN/img/linxing.png')"
		></div>
		<div class="kira-header">
    <a
        class="kira-drawer-button mdui-ripple"
        title="导航栏"
        onclick="document.querySelector('.kira-sidebar-modal').classList.add('show');document.querySelector('.kira-sidebar#sidebar').classList.add('show');"
    >
        <i class="kirafont icon-menu"></i>
    </a>
    <a href="/" title="Blog">
        <img
			src="https://cdn.jsdelivr.net/gh/Chocolate-Black/pictureCDN/img/1.png"
			alt="ChocolateBlack"
		/>
    </a>
</div>
		<div class="kira-body">
			<div class="kira-sidebar" id="sidebar">
	<div class="kira-avatar mdui-ripple">
		<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/Chocolate-Black/pictureCDN/img/1.png" title="ChocolateBlack">
			<img
				src="https://cdn.jsdelivr.net/gh/Chocolate-Black/pictureCDN/img/1.png"
				alt="ChocolateBlack"
			/>
		</a>
	</div>
	<div class="kira-count">
		<div><span>文章</span>9</div>
		<div><span>标签</span>22</div>
		<div><span>分类</span>5</div>
	</div>
	<div class="kira-list">
		
		<a
			class="kira-list-item mdui-ripple false"
			href="/"
			title="回到首页"
		>
			<i
				class="kirafont icon-home"
			></i>
			<div class="kira-list-item-content">回到首页</div>
		</a>
		
		<a
			class="kira-list-item mdui-ripple false"
			href="/archive.html"
			title="文章归档"
		>
			<i
				class="kirafont icon-container"
			></i>
			<div class="kira-list-item-content">文章归档</div>
		</a>
		
		<a
			class="kira-list-item mdui-ripple false"
			href="/about.html"
			title="关于本人"
		>
			<i
				class="kirafont icon-user"
			></i>
			<div class="kira-list-item-content">关于本人</div>
		</a>
		
		<a
			class="kira-list-item mdui-ripple false"
			href="/friends.html"
			title="我的朋友"
		>
			<i
				class="kirafont icon-team"
			></i>
			<div class="kira-list-item-content">我的朋友</div>
		</a>
		
	</div>
	<aside id="kira-sidebar">
		 <div class="kira-widget-wrap">
	<div class="kira-widget kira-social">
		<a
			class="mdui-ripple"
			href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=1106187173&website=www.oicqzone.com"
			target="_blank"
			mdui-tooltip="{content: 'QQ'}"
			style="
				color: rgb(49, 174, 255);
				background-color: rgba(49, 174, 255, .1);
			"
		>
			<i
				class="kirafont icon-QQ"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://space.bilibili.com/2106744"
			target="_blank"
			mdui-tooltip="{content: '哔哩哔哩'}"
			style="
				color: rgb(231, 106, 141);
				background-color: rgba(231, 106, 141, .15);
			"
		>
			<i
				class="kirafont icon-bilibili"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://github.com/Chocolate-Black"
			target="_blank"
			mdui-tooltip="{content: 'GitHub'}"
			style="
				color: rgb(25, 23, 23);
				background-color: rgba(25, 23, 23, .15);
			"
		>
			<i
				class="kirafont icon-github"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://gitee.com/xu_jing_yu/"
			target="_blank"
			mdui-tooltip="{content: 'Gitee'}"
			style="
				color: rgb(165, 15, 15);
				background-color: rgba(165, 15, 15, .15);
			"
		>
			<i
				class="kirafont icon-gitee"
			></i> </a
		>
	</div>
</div>
  
<div class="kira-widget-wrap">
  <h3 class="kira-widget-title">分类</h3>
  <div class="kira-widget">

    <ul class="category-list">

      


      

      

      <li class="category-list-item">
        <a class="category-list-link" href="/categories/同人/">同人</a>
        <span class="category-list-count">1</span>
      </li>

      

      <li class="category-list-item">
        <a class="category-list-link" href="/categories/我的项目/">我的项目</a>
        <span class="category-list-count">1</span>
      </li>

      

      <li class="category-list-item">
        <a class="category-list-link" href="/categories/技术教程/">技术教程</a>
        <span class="category-list-count">4</span>
      </li>

      

      <li class="category-list-item">
        <a class="category-list-link" href="/categories/经验分享/">经验分享</a>
        <span class="category-list-count">2</span>
      </li>

      

      <li class="category-list-item">
        <a class="category-list-link" href="/categories/评测/">评测</a>
        <span class="category-list-count">3</span>
      </li>

      
    </ul>

  </div>
</div>
  
<div class="kira-widget-wrap">
	<div id="randomtagcloud" class="kira-widget tagcloud kira-rainbow"><a href="/tags/AVG/" style="font-size: 20px;">AVG</a> <a href="/tags/CMVS-PMVS/" style="font-size: 10px;">CMVS-PMVS</a> <a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">C语言</a> <a href="/tags/LSTM/" style="font-size: 15px;">LSTM</a> <a href="/tags/OpenMVG/" style="font-size: 10px;">OpenMVG</a> <a href="/tags/%E4%B8%89%E7%BB%B4%E9%87%8D%E5%BB%BA/" style="font-size: 10px;">三维重建</a> <a href="/tags/%E4%B8%B0%E8%A3%95%E4%B9%8B%E8%A7%92/" style="font-size: 10px;">丰裕之角</a> <a href="/tags/%E4%BA%BA%E4%BD%93%E5%8A%A8%E4%BD%9C%E8%AF%86%E5%88%AB/" style="font-size: 10px;">人体动作识别</a> <a href="/tags/%E5%8D%8F%E5%90%8C%E8%BF%87%E6%BB%A4/" style="font-size: 10px;">协同过滤</a> <a href="/tags/%E5%9B%BE%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/" style="font-size: 10px;">图神经网络</a> <a href="/tags/%E5%A4%8F%E4%BB%A4%E8%90%A5/" style="font-size: 10px;">夏令营</a> <a href="/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 10px;">微信小程序</a> <a href="/tags/%E6%89%8B%E6%9C%BA%E6%B8%B8%E6%88%8F/" style="font-size: 10px;">手机游戏</a> <a href="/tags/%E6%89%93%E5%81%87/" style="font-size: 10px;">打假</a> <a href="/tags/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/" style="font-size: 15px;">推荐系统</a> <a href="/tags/%E6%96%B0%E6%B5%B7%E8%AF%9A/" style="font-size: 10px;">新海诚</a> <a href="/tags/%E6%98%8E%E6%97%A5%E6%96%B9%E8%88%9F/" style="font-size: 10px;">明日方舟</a> <a href="/tags/%E6%B0%B4%E6%9C%88%E9%99%B5/" style="font-size: 10px;">水月陵</a> <a href="/tags/%E7%94%B5%E5%BD%B1/" style="font-size: 10px;">电影</a> <a href="/tags/%E7%A7%8B%E4%B9%8B%E5%9B%9E%E5%BF%86/" style="font-size: 10px;">秋之回忆</a> <a href="/tags/%E9%93%83%E8%8A%BD%E4%B9%8B%E6%97%85/" style="font-size: 10px;">铃芽之旅</a> <a href="/tags/%E9%9F%B3%E4%B9%90/" style="font-size: 10px;">音乐</a></div>
	
</div>

 
	</aside>
	<div class="kira-copyright">
		&copy; 2023
		<a href="/">ChocolateBlack</a
		>
		Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> &
		<!-- TODO: github 链接 -->
		<a href="https://github.com/ch1ny/kira-hexo/" target="_blank">Kira-Hexo</a>
		<br />
		
			<a href="https://beian.miit.gov.cn/" target="_blank">赣ICP备******号</a>
		
		
	</div>
</div>
<div class="kira-sidebar-modal" id="sidebar-modal" onclick="(function(self) {
	self.classList.remove('show');
	document.querySelector('.kira-sidebar.show#sidebar').classList.remove('show');
})(this)"></div>
			<div class="kira-content">
				<div id="kira-top-header"></div>
				<div class="kira-main-content">
					
<link rel="stylesheet" href="/css/kira-image.css">

<script src="/js/kira-image.js"></script>
<div class="kira-image">
    <div class="kira-image-modal">
        <div class="kira-image-header">
            <div class="kira-image-counter"></div>
            <div class="kira-image-title"></div>
            <div class="kira-image-operation">
                <div class="kira-image-operation-button" id="kira-image-operation-button-zoom">
                    <i class="kirafont icon-zoom-in"></i>
                </div>
                <div class="kira-image-operation-button" id="kira-image-operation-button-close">
                    <i class="kirafont icon-close"></i>
                </div>
            </div>
        </div>
        <div class="kira-image-container">
            <div class="kira-image-prev-button-panel">
                <div class="kira-image-exchange-button">
                    <i class="kirafont icon-left"></i>
                </div>
            </div>
            <div class="kira-image-list">
                <div class="kira-image-prev">
                    <img />
                </div>
                <div class="kira-image-now">
                    <img />
                </div>
                <div class="kira-image-next">
                    <img />
                </div>
            </div>
            <div class="kira-image-next-button-panel">
                <div class="kira-image-exchange-button">
                    <i class="kirafont icon-right"></i>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="kira-post">
	<article>
		
		<div class="kira-post-cover">
			<img
				data-src="https://cdn.jsdelivr.net/gh/Chocolate-Black/pictureCDN/img/00002.png"
				data-sizes="auto"
				alt="C语言实现LSTM算法"
				class="lazyload kira-post-cover-image disabled-kira-image"
			/>
			<h1>C语言实现LSTM算法</h1>
		</div>
		
		<div class="kira-post-meta kira-rainbow" style="margin:10px 0!important;">
			<a><i class="kirafont icon-calendar-fill"></i>2020年10月06日</a>
			<a><i class="kirafont icon-areachart"></i>6.6k 字</a>
			<a><i class="kirafont icon-time-circle-fill"></i>大概 36 分钟</a>
		</div>
		<h2><span id="1算法介绍">1.算法介绍</span></h2><p>LSTM，长短期记忆网络，全称为Long Short Term Memory networks。它是基于RNN的一种时间循环神经网络。</p>
<p>在理解LSTM之前，首先需要了解循环神经网络（RNN）的原理。</p>
<h3><span id="11-rnn与lstm">1.1 RNN与LSTM</span></h3><p>人的思维是连续的，思考问题并不会从头开始，而是会“结合上下文”。传统的神经网络并不能做到这点，而RNN正是这一问题的解决方案。</p>
<p>循环神经网络（RNN）中的神经元，可以把输出值作为下一个神经元的输入值的一部分，进而保证神经网络能够连续“思考”。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Chocolate-Black/pictureCDN/img/v2-3c00aaedbff2ede4dac29265592c5164_1440w.png"></p>
<p>然而RNN并不完美，它存在“长依赖”的问题。比方说，假设想让RNN根据一段不完整的句子来预测缺失的单词，例如“I grew up in France… I speak fluent ________.”（缺失的单词为French)，则有用的信息主要集中在前半句。然而要预测的单词却和前面有用的信息距离较远，这会导致RNN很难学习到有用的信息。</p>
<p>而LSTM解决了RNN的长依赖问题。如图所示，LSTM也是链状结构，但它和RNN的不同之处在于中间的神经元变成了一个较为复杂的细胞，其主要由遗忘门、输入门、输出门和记忆部分组成。而这个模块正是LSTM的核心。</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="https://cdn.jsdelivr.net/gh/Chocolate-Black/pictureCDN/img/v2-70de134dda26df52dc1fba6900a87873_1440w.jpg" alt="img" class="lazyload"></p>
<h2><span id="2算法实现步骤"><strong>2.算法实现步骤</strong></span></h2><h3><span id="21-读取csv"><strong>2.1  读取csv</strong></span></h3><p>该步骤代码与前面代码一致，不再重复给出。</p>
<h3><span id="22-划分数据为k折"><strong>2.2  划分数据为k折</strong></span></h3><p>该步骤代码与前面代码一致，不再重复给出。</p>
<h3><span id="23-核心算法"><strong>2.3  核心算法</strong></span></h3><h3><span id="231-初始化"><strong>2.3.1 初始化</strong></span></h3><p>首先我们需要确定LSTM的细胞数、输入结点数（$x_t$的维度）和隐藏结点数（$h_t$的维度）。以本节为例，设置输入结点数为2，隐藏结点数为12，细胞数为8。代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> innode  2       <span class="hljs-comment">//输入结点数</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> hidenode  2   <span class="hljs-comment">//隐藏结点数</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> cell_num 8  <span class="hljs-comment">//LSTM细胞数 </span></span><br></code></pre></td></tr></table></figure>

<p>依照定义，我们可以初始化LSTM网络的权重矩阵：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">double</span> W_I[innode][hidenode];     <span class="hljs-comment">//连接输入与细胞输入门的权值矩阵</span><br><span class="hljs-type">double</span> U_I[hidenode][hidenode];   <span class="hljs-comment">//连接上一细胞输出与本细胞单元中输入门的权值矩阵</span><br><span class="hljs-type">double</span> W_F[innode][hidenode];     <span class="hljs-comment">//连接输入与细胞遗忘门的权值矩阵</span><br><span class="hljs-type">double</span> U_F[hidenode][hidenode];   <span class="hljs-comment">//连接上一细胞与本细胞中遗忘门的权值矩阵</span><br><span class="hljs-type">double</span> W_O[innode][hidenode];     <span class="hljs-comment">//连接输入与细胞输出门的权值矩阵</span><br><span class="hljs-type">double</span> U_O[hidenode][hidenode];   <span class="hljs-comment">//连接上一细胞与现在时刻的细胞的权值矩阵</span><br><span class="hljs-type">double</span> W_G[innode][hidenode];     <span class="hljs-comment">//用于产生新记忆的权值矩阵</span><br><span class="hljs-type">double</span> U_G[hidenode][hidenode];   <span class="hljs-comment">//用于产生新记忆的权值矩阵</span><br><span class="hljs-type">double</span> W_out[hidenode];  <span class="hljs-comment">//连接隐含层与输出层的权值矩阵</span><br><br><span class="hljs-type">int</span> i,j;<br><br><span class="hljs-comment">// 初始化</span><br><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;innode;i++)&#123;<br> <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;hidenode;j++)&#123;<br>     W_I[i][j] = <span class="hljs-number">1</span>;<br>     W_F[i][j] = <span class="hljs-number">1</span>;<br>     W_O[i][j] = <span class="hljs-number">1</span>;<br>     W_G[i][j] = <span class="hljs-number">1</span>;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;W_I[%d][%d] = %f,&quot;</span>,i,j,W_I[i][j]);<br>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;W_F[%d][%d] = %f,&quot;</span>,i,j,W_F[i][j]);<br>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;W_O[%d][%d] = %f,&quot;</span>,i,j,W_O[i][j]);<br>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;W_G[%d][%d] = %f\n&quot;</span>,i,j,W_G[i][j]);<br> &#125;<br>&#125;<br><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;hidenode;i++)&#123;<br> <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;hidenode;j++)&#123;<br>  U_I[i][j] = <span class="hljs-number">1</span>;<br>  U_F[i][j] = <span class="hljs-number">1</span>;<br>  U_O[i][j] = <span class="hljs-number">1</span>;<br>  U_G[i][j] = <span class="hljs-number">1</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;U_I[%d][%d] = %f,&quot;</span>,i,j,U_I[i][j]);<br>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;U_F[%d][%d] = %f,&quot;</span>,i,j,U_F[i][j]);<br>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;U_O[%d][%d] = %f,&quot;</span>,i,j,U_O[i][j]);<br>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;U_G[%d][%d] = %f\n&quot;</span>,i,j,U_G[i][j]);<br> &#125;<br> W_out[i] = <span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;W_out[%d] = %f\n&quot;</span>,i,W_out[i]);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>将权重矩阵的值打印出来结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">W_I[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span>,W_F[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span>,W_O[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span>,W_G[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span><br>W_I[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span>,W_F[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span>,W_O[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span>,W_G[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span><br>W_I[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span>,W_F[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span>,W_O[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span>,W_G[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span><br>W_I[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span>,W_F[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span>,W_O[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span>,W_G[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span><br>U_I[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span>,U_F[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span>,U_O[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span>,U_G[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span><br>U_I[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span>,U_F[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span>,U_O[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span>,U_G[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span><br>W_out[<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span><br>U_I[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span>,U_F[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span>,U_O[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span>,U_G[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span><br>U_I[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span>,U_F[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span>,U_O[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span>,U_G[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span><br>W_out[<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span><br></code></pre></td></tr></table></figure>

<p>之后，在训练过程中，我们需要定义二维数组来保存各个门和记忆的数组：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">double</span> **I_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *)); <span class="hljs-comment">//保存输入门信息</span><br><span class="hljs-type">double</span> **F_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *)); <span class="hljs-comment">//保存遗忘门信息</span><br><span class="hljs-type">double</span> **O_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *)); <span class="hljs-comment">//保存输出门信息</span><br><span class="hljs-type">double</span> **G_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *)); <span class="hljs-comment">//保存记忆信息(C`t)    </span><br><span class="hljs-type">double</span> **S_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num+<span class="hljs-number">1</span>)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *)); <span class="hljs-comment">//保存记忆信息(Ct) </span><br><span class="hljs-type">double</span> **h_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num+<span class="hljs-number">1</span>)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *)); <span class="hljs-comment">//保存细胞输出信息</span><br>  <br><span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;cell_num;j++)&#123;<br> S_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br> h_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br> I_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br> F_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br> O_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br> G_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>&#125;<br> S_vector[cell_num] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br> h_vector[cell_num] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br></code></pre></td></tr></table></figure>

<h3><span id="232-构建细胞"><strong>2.3.2 构建细胞</strong></span></h3><p>LSTM的细胞主要由以下四个部分组成：</p>
<ul>
<li>遗忘门</li>
<li>输入门</li>
<li>输出门</li>
<li>记忆部分</li>
</ul>
<h3><span id="2321-遗忘门"><strong>2.3.2.1 遗忘门</strong></span></h3><p>遗忘门主要负责接受并筛选上一个细胞的信息。设为遗忘门输出值，为细胞输出值，为输入值，表示激活函数，和代表遗忘门的权重和偏差，其计算公式为：</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="https://picx.zhimg.com/80/v2-c45482c2ad1c31101e32b9cd6e0fa347_1440w.jpg?source=d16d100b" alt="img" class="lazyload"></p>
<h3><span id="2322-输入门"><strong>2.3.2.2 输入门</strong></span></h3><p>输入门主要负责控制新信息的传入，并将新信息传入记忆中。设和为输入门输出值，、和、代表输入门的权重和偏差，其计算公式为：</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="https://pic1.zhimg.com/80/v2-b49674307920990ec3195934fb6831f1_1440w.jpg?source=d16d100b" alt="img" class="lazyload"></p>
<h3><span id="2323-记忆部分"><strong>2.3.2.3 记忆部分</strong></span></h3><p>记忆主要负责记录该细胞里的信息，并影响后续的细胞。设为记忆值，则公式如下：</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="https://pic1.zhimg.com/80/v2-a52ed13f64553d47891c2ef4f2fa9e27_1440w.jpg?source=d16d100b" alt="img" class="lazyload"></p>
<h3><span id="2324-输出门"><strong>2.3.2.4 输出门</strong></span></h3><p>输出门主要负责输出值，同时输出值也将作为下一个细胞输入的一部分。设为细胞输出值，和代表输出门的权重和偏差，则公式如下：</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="https://picx.zhimg.com/80/v2-bc1a2abe05f5c30590f62b3936f4b590_1440w.jpg?source=d16d100b" alt="img" class="lazyload"></p>
<h3><span id="2325-代码"><strong>2.3.2.5 代码</strong></span></h3><p>将以上四个部分结合起来，便可以构成LSTM的细胞。以本文为例，将LSTM前向传播过程写成代码片段如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;math.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdlib.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;time.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;assert.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdio.h&quot;</span> </span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> innode  2       <span class="hljs-comment">//输入结点数</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> hidenode  2   <span class="hljs-comment">//隐藏结点数</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> cell_num 8  <span class="hljs-comment">//LSTM细胞数 </span></span><br><br><span class="hljs-type">double</span> <span class="hljs-title function_">sigmoid</span><span class="hljs-params">(<span class="hljs-type">double</span> x)</span> <br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1.0</span> / (<span class="hljs-number">1.0</span> + <span class="hljs-built_in">exp</span>(-x));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>&#123;<br> <span class="hljs-type">double</span> W_I[innode][hidenode];     <span class="hljs-comment">//连接输入与细胞输入门的权值矩阵</span><br> <span class="hljs-type">double</span> U_I[hidenode][hidenode];   <span class="hljs-comment">//连接上一细胞输出与本细胞单元中输入门的权值矩阵</span><br> <span class="hljs-type">double</span> W_F[innode][hidenode];     <span class="hljs-comment">//连接输入与细胞遗忘门的权值矩阵</span><br> <span class="hljs-type">double</span> U_F[hidenode][hidenode];   <span class="hljs-comment">//连接上一细胞与本细胞中遗忘门的权值矩阵</span><br> <span class="hljs-type">double</span> W_O[innode][hidenode];     <span class="hljs-comment">//连接输入与细胞输出门的权值矩阵</span><br> <span class="hljs-type">double</span> U_O[hidenode][hidenode];   <span class="hljs-comment">//连接上一细胞与现在时刻的细胞的权值矩阵</span><br> <span class="hljs-type">double</span> W_G[innode][hidenode];     <span class="hljs-comment">//用于产生新记忆的权值矩阵</span><br> <span class="hljs-type">double</span> U_G[hidenode][hidenode];   <span class="hljs-comment">//用于产生新记忆的权值矩阵</span><br> <span class="hljs-type">double</span> W_out[hidenode];  <span class="hljs-comment">//连接隐含层与输出层的权值矩阵</span><br> <br> <span class="hljs-type">int</span> i,j;<br> <span class="hljs-comment">// 初始化</span><br> <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;innode;i++)&#123;<br>  <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;hidenode;j++)&#123;<br>      W_I[i][j] = <span class="hljs-number">1</span>;<br>      W_F[i][j] = <span class="hljs-number">1</span>;<br>      W_O[i][j] = <span class="hljs-number">1</span>;<br>      W_G[i][j] = <span class="hljs-number">1</span>;<br>  &#125;<br> &#125;<br> <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;hidenode;i++)&#123;<br>  <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;hidenode;j++)&#123;<br>   U_I[i][j] = <span class="hljs-number">1</span>;<br>   U_F[i][j] = <span class="hljs-number">1</span>;<br>   U_O[i][j] = <span class="hljs-number">1</span>;<br>   U_G[i][j] = <span class="hljs-number">1</span>; <br>  &#125;<br>  W_out[i] = <span class="hljs-number">1</span>;<br> &#125;<br> <span class="hljs-type">double</span> **I_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *));<br> <span class="hljs-type">double</span> **F_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *));<br> <span class="hljs-type">double</span> **O_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *));    <br> <span class="hljs-type">double</span> **G_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *));      <br> <span class="hljs-type">double</span> **M_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num+<span class="hljs-number">1</span>)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *));     <br> <span class="hljs-type">double</span> **h_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num+<span class="hljs-number">1</span>)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *));     <br> <span class="hljs-type">double</span> y_delta[cell_num];    <span class="hljs-comment">//保存误差关于输出层的偏导</span><br>  <br> <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;cell_num;j++)&#123;<br>  M_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>  h_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>  I_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>  F_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>  O_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>  G_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br> &#125;<br> M_vector[cell_num] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br> h_vector[cell_num] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br> <br>    <span class="hljs-type">int</span> predict[cell_num];     <span class="hljs-comment">//保存每次生成的预测值</span><br> <br>        <br>    <span class="hljs-type">double</span> M[hidenode];     <span class="hljs-comment">//记忆值</span><br>    <span class="hljs-type">double</span> h[hidenode];     <span class="hljs-comment">//输出值</span><br>        <br> <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;hidenode; j++)  <br>    &#123;<br>        M[j] = <span class="hljs-number">0</span>;<br>        h[j] = <span class="hljs-number">0</span>;<br>        M_vector[<span class="hljs-number">0</span>][j] = <span class="hljs-number">0</span>;<br>        h_vector[<span class="hljs-number">0</span>][j] = <span class="hljs-number">0</span>;<br>    &#125;<br>    <br> <span class="hljs-type">int</span> a[<span class="hljs-number">8</span>] = &#123;<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>&#125;; <span class="hljs-comment">//设a为12</span><br> <span class="hljs-type">int</span> b[<span class="hljs-number">8</span>] = &#123;<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>&#125;; <span class="hljs-comment">//设b为15</span><br> <span class="hljs-type">int</span> p;<br> <span class="hljs-type">int</span> x[<span class="hljs-number">2</span>];<br> <span class="hljs-keyword">for</span>(p=<span class="hljs-number">0</span>;p&lt;cell_num;p++)&#123;<br>  x[<span class="hljs-number">0</span>]=a[p]; <span class="hljs-comment">//输入值</span><br>  x[<span class="hljs-number">1</span>]=b[p]; <span class="hljs-comment">//输入值</span><br>  <span class="hljs-type">double</span> in_gate[hidenode];     <span class="hljs-comment">//输入门</span><br>  <span class="hljs-type">double</span> out_gate[hidenode];    <span class="hljs-comment">//输出门</span><br>  <span class="hljs-type">double</span> forget_gate[hidenode]; <span class="hljs-comment">//遗忘门</span><br>  <span class="hljs-type">double</span> g_gate[hidenode];      <span class="hljs-comment">//C`t </span><br>  <span class="hljs-type">double</span> memory[hidenode];       <span class="hljs-comment">//记忆值</span><br>  <span class="hljs-type">double</span> h[hidenode];           <span class="hljs-comment">//隐层输出值</span><br>              <br>  <span class="hljs-type">double</span> *h_pre = h_vector[p];<br>  <span class="hljs-type">double</span> *memory_pre = M_vector[p];<br>  <br>  <span class="hljs-type">int</span> k;     <br>  <span class="hljs-keyword">for</span>(k=<span class="hljs-number">0</span>; k&lt;hidenode; k++)<br>  &#123;   <span class="hljs-comment">//输入层转播到隐层</span><br>   <span class="hljs-type">double</span> inGate = <span class="hljs-number">0.0</span>;<br>      <span class="hljs-type">double</span> outGate = <span class="hljs-number">0.0</span>;<br>      <span class="hljs-type">double</span> forgetGate = <span class="hljs-number">0.0</span>;<br>      <span class="hljs-type">double</span> gGate = <span class="hljs-number">0.0</span>;<br>      <span class="hljs-type">double</span> s = <span class="hljs-number">0.0</span>;<br>      <br>   <span class="hljs-type">int</span> m;            <br>      <span class="hljs-keyword">for</span>(m=<span class="hljs-number">0</span>; m&lt;innode; m++) <br>      &#123;<br>          inGate += x[m] * W_I[m][k]; <br>          outGate += x[m] * W_O[m][k];<br>          forgetGate += x[m] * W_F[m][k];<br>          gGate += x[m] * W_G[m][k];<br>      &#125;<br>                  <br>      <span class="hljs-keyword">for</span>(m=<span class="hljs-number">0</span>; m&lt;hidenode; m++)<br>         &#123;<br>             inGate += h_pre[m] * U_I[m][k];<br>             outGate += h_pre[m] * U_O[m][k];<br>             forgetGate += h_pre[m] * U_F[m][k];<br>             gGate += h_pre[m] * U_G[m][k];<br>         &#125;<br>   <br>      <br>      in_gate[k] = sigmoid(inGate);<br>      out_gate[k] = sigmoid(outGate);<br>      forget_gate[k] = sigmoid(forgetGate);<br>      g_gate[k] = sigmoid(gGate);<br>   <br>      <span class="hljs-type">double</span> m_pre = memory_pre[k];<br>      memory[k] = forget_gate[k] * m_pre + g_gate[k] * in_gate[k];<br>                  <br>      h[k] = out_gate[k] * <span class="hljs-built_in">tanh</span>(memory[k]);<br>                  <br>   I_vector[p][k] = in_gate[k];<br>   F_vector[p][k] = forget_gate[k];<br>   O_vector[p][k] = out_gate[k];<br>   M_vector[p+<span class="hljs-number">1</span>][k] = memory[k];<br>   G_vector[p][k] = g_gate[k];<br>   h_vector[p+<span class="hljs-number">1</span>][k] = h[k];<br>   &#125;<br>   <br>   <span class="hljs-comment">//隐藏层传播到输出层</span><br>   <span class="hljs-type">double</span> out = <span class="hljs-number">0.0</span>;<br>   <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;hidenode; j++)&#123;<br>      out += h[j] * W_out[j]; <br>   &#125;<br>      <br>   <span class="hljs-type">double</span> y;        <br>   y = sigmoid(out);               <span class="hljs-comment">//输出层各单元输出</span><br>   predict[p] = <span class="hljs-built_in">floor</span>(y + <span class="hljs-number">0.5</span>);   <span class="hljs-comment">//记录预测值</span><br>   <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;predict[%d] = %f\n&quot;</span>,p,predict[p]);<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出的结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">predict[<span class="hljs-number">0</span>] = <span class="hljs-number">0.000000</span><br>predict[<span class="hljs-number">1</span>] = <span class="hljs-number">0.000000</span><br>predict[<span class="hljs-number">2</span>] = <span class="hljs-number">0.000000</span><br>predict[<span class="hljs-number">3</span>] = <span class="hljs-number">0.000000</span><br>predict[<span class="hljs-number">4</span>] = <span class="hljs-number">0.000000</span><br>predict[<span class="hljs-number">5</span>] = <span class="hljs-number">0.000000</span><br>predict[<span class="hljs-number">6</span>] = <span class="hljs-number">0.000000</span><br>predict[<span class="hljs-number">7</span>] = <span class="hljs-number">0.000000</span><br></code></pre></td></tr></table></figure>

<h3><span id="233-反向传播"><strong>2.3.3 反向传播</strong></span></h3><p>首先，我们先求预测值和实际值的误差：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">double</span> y_delta[cell_num];<br><span class="hljs-keyword">for</span>(p=<span class="hljs-number">0</span>;p&lt;cell_num;p++)&#123;<br> <span class="hljs-comment">//前向传播部分略</span><br> <span class="hljs-comment">//保存标准误差关于输出层的偏导</span><br> y_delta[p] = (t - y) * dsigmoid(y);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;y_delta[%d] = %f\n&quot;</span>,p,y_delta[p]);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>得到误差如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">y_delta[<span class="hljs-number">0</span>] = <span class="hljs-number">-0.138149</span><br>y_delta[<span class="hljs-number">1</span>] = <span class="hljs-number">-0.145825</span><br>y_delta[<span class="hljs-number">2</span>] = <span class="hljs-number">-0.148124</span><br>y_delta[<span class="hljs-number">3</span>] = <span class="hljs-number">0.055493</span><br>y_delta[<span class="hljs-number">4</span>] = <span class="hljs-number">0.017513</span><br>y_delta[<span class="hljs-number">5</span>] = <span class="hljs-number">-0.096220</span><br>y_delta[<span class="hljs-number">6</span>] = <span class="hljs-number">0.014835</span><br>y_delta[<span class="hljs-number">7</span>] = <span class="hljs-number">0.014861</span><br></code></pre></td></tr></table></figure>

<p>之后进行反向传播，更新权值矩阵：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//误差反向传播</span><br> <br><span class="hljs-comment">//隐含层偏差，通过当前之后一个时间点的隐含层误差和当前输出层的误差计算</span><br><span class="hljs-type">double</span> h_delta[hidenode];  <br><span class="hljs-type">double</span> O_delta[hidenode];<br><span class="hljs-type">double</span> I_delta[hidenode];<br><span class="hljs-type">double</span> F_delta[hidenode];<br><span class="hljs-type">double</span> G_delta[hidenode];<br><span class="hljs-type">double</span> memory_delta[hidenode];<br><span class="hljs-comment">//当前时间之后的一个隐藏层误差</span><br><span class="hljs-type">double</span> O_future_delta[hidenode]; <br><span class="hljs-type">double</span> I_future_delta[hidenode];<br><span class="hljs-type">double</span> F_future_delta[hidenode];<br><span class="hljs-type">double</span> G_future_delta[hidenode];<br><span class="hljs-type">double</span> memory_future_delta[hidenode];<br><span class="hljs-type">double</span> forget_gate_future[hidenode];<br><span class="hljs-type">int</span> l_rate = <span class="hljs-number">0.1</span>;<br><span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;hidenode; j++)<br>&#123;<br> O_future_delta[j] = <span class="hljs-number">0.0</span>;<br> I_future_delta[j] = <span class="hljs-number">0.0</span>;<br> F_future_delta[j] = <span class="hljs-number">0.0</span>;<br> G_future_delta[j] = <span class="hljs-number">0.0</span>;<br> memory_future_delta[j] = <span class="hljs-number">0.0</span>;<br> forget_gate_future[j] = <span class="hljs-number">0.0</span>;<br>&#125;<br>         <br><span class="hljs-keyword">for</span>(p=cell_num<span class="hljs-number">-1</span>; p&gt;=<span class="hljs-number">0</span> ; p--)<br>&#123;<br>    x[<span class="hljs-number">0</span>] = a[p];<br> x[<span class="hljs-number">1</span>] = b[p];<br>  <br> <span class="hljs-comment">//当前隐藏层</span><br> <span class="hljs-type">double</span> in_gate[hidenode];     <span class="hljs-comment">//输入门</span><br> <span class="hljs-type">double</span> out_gate[hidenode];    <span class="hljs-comment">//输出门</span><br> <span class="hljs-type">double</span> forget_gate[hidenode]; <span class="hljs-comment">//遗忘门</span><br> <span class="hljs-type">double</span> g_gate[hidenode];      <span class="hljs-comment">//C`t</span><br> <span class="hljs-type">double</span> memory[hidenode];     <span class="hljs-comment">//记忆值</span><br> <span class="hljs-type">double</span> h[hidenode];         <span class="hljs-comment">//隐层输出值</span><br> <span class="hljs-keyword">for</span>(k=<span class="hljs-number">0</span>;k&lt;hidenode;k++)&#123;<br>  in_gate[k] = I_vector[p][k];<br>  out_gate[k] = O_vector[p][k];<br>  forget_gate[k] = F_vector[p][k]; <span class="hljs-comment">//遗忘门</span><br>     g_gate[k] = G_vector[p][k];      <span class="hljs-comment">//C`t </span><br>     memory[k] = M_vector[p+<span class="hljs-number">1</span>][k];     <span class="hljs-comment">//记忆值</span><br>     h[k] = h_vector[p+<span class="hljs-number">1</span>][k];         <span class="hljs-comment">//隐层输出值</span><br> &#125;<br> <span class="hljs-comment">//前一个隐藏层</span><br> <span class="hljs-type">double</span> *h_pre = h_vector[p];   <br> <span class="hljs-type">double</span> *memory_pre = M_vector[p];<br>  <br> <span class="hljs-comment">//更新隐含层和输出层之间的连接权</span><br> <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;hidenode; j++)&#123;<br>     W_out[j] += l_rate * y_delta[p] * h[j];  <br> &#125;<br>                 <br> <span class="hljs-comment">//对于网络中每个隐藏单元，计算误差项，并更新权值</span><br> <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;hidenode; j++) <br> &#123;<br>  h_delta[j] = y_delta[p] * W_out[j];<br>     <span class="hljs-keyword">for</span>(k=<span class="hljs-number">0</span>; k&lt;hidenode; k++)<br>     &#123;<br>      h_delta[j] += I_future_delta[k] * U_I[j][k];<br>         h_delta[j] += F_future_delta[k] * U_F[j][k];<br>         h_delta[j] += O_future_delta[k] * U_O[j][k];<br>         h_delta[j] += G_future_delta[k] * U_G[j][k];<br>     &#125;<br>  <br>     O_delta[j] = <span class="hljs-number">0.0</span>;<br>     I_delta[j] = <span class="hljs-number">0.0</span>;<br>     F_delta[j] = <span class="hljs-number">0.0</span>;<br>     G_delta[j] = <span class="hljs-number">0.0</span>;<br>     memory_delta[j] = <span class="hljs-number">0.0</span>;<br>  <br>     <span class="hljs-comment">//隐含层的校正误差</span><br>     O_delta[j] = h_delta[j] * <span class="hljs-built_in">tanh</span>(memory[j]) * dsigmoid(out_gate[j]);<br>     memory_delta[j] = h_delta[j] * out_gate[j] * dtanh(memory[j]) +<br>                                  memory_future_delta[j] * forget_gate_future[j];<br>                 F_delta[j] = memory_delta[j] * memory_pre[j] * dsigmoid(forget_gate[j]);<br>     I_delta[j] = memory_delta[j] * g_gate[j] * dsigmoid(in_gate[j]);<br>     G_delta[j] = memory_delta[j] * in_gate[j] * dsigmoid(g_gate[j]);<br>                 <br>     O_future_delta[j] = O_delta[j];<br>     F_future_delta[j] = F_delta[j];<br>     I_future_delta[j] = I_delta[j];<br>     G_future_delta[j] = G_delta[j];<br>     memory_future_delta[j] = memory_delta[j];<br>     forget_gate_future[j] = forget_gate[j]; <br>  <br>     <span class="hljs-comment">//更新前一个隐含层和现在隐含层之间的权值</span><br>     <span class="hljs-keyword">for</span>(k=<span class="hljs-number">0</span>; k&lt;hidenode; k++)<br>     &#123;<br>      U_I[k][j] += l_rate * I_delta[j] * h_pre[k];<br>         U_F[k][j] += l_rate * F_delta[j] * h_pre[k];<br>         U_O[k][j] += l_rate * O_delta[j] * h_pre[k];<br>         U_G[k][j] += l_rate * G_delta[j] * h_pre[k];<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;U_I[%d][%d] = %f,&quot;</span>,k,j,U_I[k][j]);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;U_F[%d][%d] = %f,&quot;</span>,k,j,U_F[k][j]);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;U_O[%d][%d] = %f,&quot;</span>,k,j,U_O[k][j]);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;U_G[%d][%d] = %f\n&quot;</span>,k,j,U_G[k][j]);<br>     &#125;<br>  <br>     <span class="hljs-comment">//更新输入层和隐含层之间的连接权</span><br>     <span class="hljs-keyword">for</span>(k=<span class="hljs-number">0</span>; k&lt;innode; k++)<br>     &#123;<br>      W_I[k][j] += l_rate * I_delta[j] * x[k];<br>         W_F[k][j] += l_rate * F_delta[j] * x[k];<br>         W_O[k][j] += l_rate * O_delta[j] * x[k];<br>         W_G[k][j] += l_rate * G_delta[j] * x[k];<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;W_I[%d][%d] = %f,&quot;</span>,k,j,W_I[k][j]);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;W_F[%d][%d] = %f,&quot;</span>,k,j,W_F[k][j]);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;W_O[%d][%d] = %f,&quot;</span>,k,j,W_O[k][j]);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;W_G[%d][%d] = %f\n&quot;</span>,k,j,W_G[k][j]);<br>     &#125;<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结合上述代码，把全新的权重矩阵打印如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">U_I[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">0.999978</span>,U_F[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">0.999992</span>,U_O[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">0.999968</span>,U_G[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">0.999978</span><br>U_I[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">0.999978</span>,U_F[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">0.999992</span>,U_O[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">0.999968</span>,U_G[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">0.999978</span><br>W_I[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span>,W_F[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span>,W_O[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span>,W_G[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">1.000000</span><br>W_I[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">0.999574</span>,W_F[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">0.999919</span>,W_O[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">0.999550</span>,W_G[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">0.999574</span><br>U_I[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">0.999972</span>,U_F[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">0.999989</span>,U_O[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">0.999959</span>,U_G[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">0.999972</span><br>U_I[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">0.999972</span>,U_F[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">0.999989</span>,U_O[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">0.999959</span>,U_G[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">0.999972</span><br>W_I[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span>,W_F[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span>,W_O[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span>,W_G[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">1.000000</span><br>W_I[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">0.999507</span>,W_F[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">0.999897</span>,W_O[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">0.999477</span>,W_G[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = <span class="hljs-number">0.999507</span><br></code></pre></td></tr></table></figure>

<h3><span id="234-预测"><strong>2.3.4 预测</strong></span></h3><p>训练完成后，就可以利用训练好的权重矩阵进行预测。其过程和前向传播大致相同。代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> *predictions=(<span class="hljs-type">int</span>*)<span class="hljs-built_in">malloc</span>(test_size*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br><span class="hljs-comment">// 预测</span><br><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;test_size;i++)&#123;<br> <span class="hljs-type">double</span> **M_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num+<span class="hljs-number">1</span>)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *));     <br> <span class="hljs-type">double</span> **h_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num+<span class="hljs-number">1</span>)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *));<br> <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;cell_num+<span class="hljs-number">1</span>;j++)&#123;<br>  M_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>  h_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br> &#125;<br>  <br> <span class="hljs-type">int</span> predict[cell_num];               <span class="hljs-comment">//保存每次生成的预测值</span><br>    <span class="hljs-built_in">memset</span>(predict, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(predict));<br>        <br> <span class="hljs-type">double</span> M[hidenode];     <span class="hljs-comment">//记忆值</span><br>    <span class="hljs-type">double</span> h[hidenode];     <span class="hljs-comment">//输出值</span><br>        <br>    <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;hidenode; j++)  <br>    &#123;<br>     M[j] = <span class="hljs-number">0</span>;<br>        h[j] = <span class="hljs-number">0</span>;<br>        M_vector[<span class="hljs-number">0</span>][j] = <span class="hljs-number">0</span>;<br>        h_vector[<span class="hljs-number">0</span>][j] = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-type">int</span> a_int = test[i][<span class="hljs-number">0</span>];<br>    <span class="hljs-type">int</span> a[cell_num];<br>    <span class="hljs-type">int</span> b_int = test[i][<span class="hljs-number">1</span>];<br>    <span class="hljs-type">int</span> b[cell_num];<br>    <span class="hljs-type">int</span> c_int = test[i][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span> c[cell_num];<br><br>    int2binary(a_int, a); <span class="hljs-comment">//把输入值变成二进制</span><br>    int2binary(b_int, b);<br>    int2binary(c_int, c);<br>        <br>         <br>    <span class="hljs-keyword">for</span>(p=<span class="hljs-number">0</span>;p&lt;cell_num;p++)&#123;<br>  x[<span class="hljs-number">0</span>]=a[p];<br>     x[<span class="hljs-number">1</span>]=b[p];<br>     <span class="hljs-type">double</span> in_gate[hidenode];     <span class="hljs-comment">//输入门</span><br>     <span class="hljs-type">double</span> out_gate[hidenode];    <span class="hljs-comment">//输出门</span><br>     <span class="hljs-type">double</span> forget_gate[hidenode]; <span class="hljs-comment">//遗忘门</span><br>     <span class="hljs-type">double</span> g_gate[hidenode];      <span class="hljs-comment">//C`t </span><br>     <span class="hljs-type">double</span> memory[hidenode];       <span class="hljs-comment">//记忆值</span><br>     <span class="hljs-type">double</span> h[hidenode];           <span class="hljs-comment">//隐层输出值</span><br>       <br>     <span class="hljs-keyword">for</span>(k=<span class="hljs-number">0</span>; k&lt;hidenode; k++)<br>     &#123;   <br>         <span class="hljs-comment">//输入层转播到隐层</span><br>      <span class="hljs-type">double</span> inGate = <span class="hljs-number">0.0</span>;<br>         <span class="hljs-type">double</span> outGate = <span class="hljs-number">0.0</span>;<br>         <span class="hljs-type">double</span> forgetGate = <span class="hljs-number">0.0</span>;<br>         <span class="hljs-type">double</span> gGate = <span class="hljs-number">0.0</span>;<br>         <span class="hljs-type">double</span> s = <span class="hljs-number">0.0</span>;<br>  <br>         <span class="hljs-type">double</span> *h_pre = h_vector[p];<br>         <span class="hljs-type">double</span> *memory_pre = M_vector[p];<br>                 <br>         <span class="hljs-keyword">for</span>(m=<span class="hljs-number">0</span>; m&lt;innode; m++) <br>         &#123;<br>          inGate += x[m] * W_I[m][k]; <br>             outGate += x[m] * W_O[m][k];<br>             forgetGate += x[m] * W_F[m][k];<br>             gGate += x[m] * W_G[m][k];<br>         &#125;<br>                 <br>         <span class="hljs-keyword">for</span>(m=<span class="hljs-number">0</span>; m&lt;hidenode; m++)<br>            &#123;<br>             inGate += h_pre[m] * U_I[m][k];<br>                outGate += h_pre[m] * U_O[m][k];<br>                forgetGate += h_pre[m] * U_F[m][k];<br>                gGate += h_pre[m] * U_G[m][k];<br>            &#125;<br>  <br> <br>         in_gate[k] = sigmoid(inGate);   <br>         out_gate[k] = sigmoid(outGate);<br>         forget_gate[k] = sigmoid(forgetGate);<br>         g_gate[k] = sigmoid(gGate);<br>  <br>         <span class="hljs-type">double</span> m_pre = memory_pre[k];<br>         memory[k] = forget_gate[k] * m_pre + g_gate[k] * in_gate[k];<br>         h[k] = out_gate[k] * <span class="hljs-built_in">tanh</span>(memory[k]);<br>             <br>         M_vector[p+<span class="hljs-number">1</span>][k] = memory[k];<br>   h_vector[p+<span class="hljs-number">1</span>][k] = h[k];<br>     &#125;<br><br>     <span class="hljs-comment">//隐藏层传播到输出层</span><br>     <span class="hljs-type">double</span> out = <span class="hljs-number">0.0</span>;<br>     <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;hidenode; j++)&#123;<br>      out += h[j] * W_out[j];<br>  &#125;<br>     y = sigmoid(out);               <span class="hljs-comment">//输出层各单元输出</span><br>     predict[p] = (<span class="hljs-type">int</span>)<span class="hljs-built_in">floor</span>(y + <span class="hljs-number">0.5</span>);<br> &#125;<br> <span class="hljs-built_in">free</span>(M_vector);<br> <span class="hljs-built_in">free</span>(h_vector);<br>     <br> <span class="hljs-type">double</span> out = <span class="hljs-number">0</span>;<br> <span class="hljs-keyword">for</span>(k=cell_num<span class="hljs-number">-1</span>; k&gt;=<span class="hljs-number">0</span>; k--)&#123;<br>     out += predict[k] * <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, k);<br> &#125;  <br> predictions[i] = out;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3><span id="24-计算rmse"><strong>2.4  计算RMSE</strong></span></h3><p>该步骤代码与前面代码一致，不再重复给出。</p>
<h3><span id="25-按划分的k折交叉验证计算预测所得平均rmse"><strong>2.5  按划分的k折交叉验证计算预测所得平均RMSE</strong></span></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-keyword">extern</span> <span class="hljs-type">double</span>  ***<span class="hljs-title function_">cross_validation_split</span><span class="hljs-params">(<span class="hljs-type">double</span> **dataset, <span class="hljs-type">int</span> row, <span class="hljs-type">int</span> n_folds, <span class="hljs-type">int</span> fold_size,<span class="hljs-type">int</span> col)</span>;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">double</span>* <span class="hljs-title function_">get_test_prediction</span><span class="hljs-params">(<span class="hljs-type">double</span> **train, <span class="hljs-type">double</span> **test, <span class="hljs-type">double</span> l_rate, <span class="hljs-type">int</span> n_epoch, <span class="hljs-type">int</span> train_size,<span class="hljs-type">int</span> test_size,<span class="hljs-type">int</span> col)</span>;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">double</span> <span class="hljs-title function_">accuracy_metric</span><span class="hljs-params">(<span class="hljs-type">double</span> *actual, <span class="hljs-type">double</span> *predicted, <span class="hljs-type">int</span> fold_size)</span>;<br><br><span class="hljs-type">double</span>* <span class="hljs-title function_">evaluate_algorithm</span><span class="hljs-params">(<span class="hljs-type">double</span> **dataset, <span class="hljs-type">int</span> n_folds, <span class="hljs-type">int</span> fold_size, <span class="hljs-type">double</span> l_rate, <span class="hljs-type">int</span> n_epoch,<span class="hljs-type">int</span> col,<span class="hljs-type">int</span> row)</span> <br>&#123;<br> <span class="hljs-type">double</span>*** split =  cross_validation_split(dataset, row, n_folds, fold_size,col);<br> <span class="hljs-type">int</span> i, j, k, l;<br> <span class="hljs-type">int</span> test_size = fold_size;<br> <span class="hljs-type">int</span> train_size = fold_size * (n_folds - <span class="hljs-number">1</span>);<span class="hljs-comment">//train_size个一维数组</span><br> <span class="hljs-type">double</span>* score = (<span class="hljs-type">double</span>*)<span class="hljs-built_in">malloc</span>(n_folds * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br> <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n_folds; i++) <br>    &#123;  <span class="hljs-comment">//因为要遍历删除，所以拷贝一份split</span><br>  <span class="hljs-type">double</span>*** split_copy = (<span class="hljs-type">double</span>***)<span class="hljs-built_in">malloc</span>(n_folds * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>**));<br>  <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n_folds; j++) &#123;<br>   split_copy[j] = (<span class="hljs-type">double</span>**)<span class="hljs-built_in">malloc</span>(fold_size * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>*));<br>   <span class="hljs-keyword">for</span> (k = <span class="hljs-number">0</span>; k &lt; fold_size; k++) &#123;<br>    split_copy[j][k] = (<span class="hljs-type">double</span>*)<span class="hljs-built_in">malloc</span>(col * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>   &#125;<br>  &#125;<br>  <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n_folds; j++)<br>  &#123;<br>   <span class="hljs-keyword">for</span> (k = <span class="hljs-number">0</span>; k &lt; fold_size; k++)<br>   &#123;<br>    <span class="hljs-keyword">for</span> (l = <span class="hljs-number">0</span>; l &lt; col; l++)<br>    &#123;<br>     split_copy[j][k][l] = split[j][k][l];<br>    &#125;<br>   &#125;<br>  &#125;<br>  <span class="hljs-type">double</span>** test_set = (<span class="hljs-type">double</span>**)<span class="hljs-built_in">malloc</span>(test_size * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>*));<br>  <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; test_size; j++) &#123;<span class="hljs-comment">//对test_size中的每一行</span><br>   test_set[j] = (<span class="hljs-type">double</span>*)<span class="hljs-built_in">malloc</span>(col * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>   <span class="hljs-keyword">for</span> (k = <span class="hljs-number">0</span>; k &lt; col; k++) &#123;<br>    test_set[j][k] = split_copy[i][j][k];<br>   &#125;<br>  &#125;<br>  <span class="hljs-keyword">for</span> (j = i; j &lt; n_folds - <span class="hljs-number">1</span>; j++) &#123;<br>   split_copy[j] = split_copy[j + <span class="hljs-number">1</span>];<br>  &#125;<br>  <span class="hljs-type">double</span>** train_set = (<span class="hljs-type">double</span>**)<span class="hljs-built_in">malloc</span>(train_size * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>*));<br>  <span class="hljs-keyword">for</span> (k = <span class="hljs-number">0</span>; k &lt; n_folds - <span class="hljs-number">1</span>; k++) &#123;<br>   <span class="hljs-keyword">for</span> (l = <span class="hljs-number">0</span>; l &lt; fold_size; l++) &#123;<br>    train_set[k*fold_size + l] = (<span class="hljs-type">double</span>*)<span class="hljs-built_in">malloc</span>(col * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>    train_set[k*fold_size + l] = split_copy[k][l];<br>   &#125;<br>  &#125;<br>  <span class="hljs-type">double</span> *predicted_2;<br>  predicted_2 = get_test_prediction(train_set, test_set, l_rate, n_epoch, train_size,test_size,col);<br>  <span class="hljs-type">double</span> predicted[test_size];<br>  <span class="hljs-type">double</span>* actual = (<span class="hljs-type">double</span>*)<span class="hljs-built_in">malloc</span>(test_size * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>  <span class="hljs-keyword">for</span>(l=<span class="hljs-number">0</span>;l&lt;test_size;l++)&#123;<br>   predicted[l] = (<span class="hljs-type">double</span>) *(predicted_2+l);<br>   actual[l] = test_set[l][col - <span class="hljs-number">1</span>];<br>  &#125;<br>  <span class="hljs-type">double</span> accuracy = accuracy_metric(actual, predicted, test_size);<br>  score[i] = accuracy;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;score[%d]=%f\n&quot;</span>, i, score[i]);<br>  <span class="hljs-built_in">free</span>(split_copy);<br> &#125;<br> <span class="hljs-type">double</span> total = <span class="hljs-number">0.0</span>;<br> <span class="hljs-keyword">for</span> (l = <span class="hljs-number">0</span>; l &lt; n_folds; l++) &#123;<br>  total += score[l];<br> &#125;<br> <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;mean_accuracy=%f\n&quot;</span>, total / n_folds);<br> <span class="hljs-keyword">return</span> score;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2><span id="3完整算法及应用"><strong>3.完整算法及应用</strong></span></h2><p>本节将用LSTM网络让模型学习加法，其过程如下：</p>
<ul>
<li>读取数据</li>
<li>把数据转换为二进制格式（输入与实际值）</li>
<li>训练模型</li>
<li>预测</li>
</ul>
<p>下面给出完整的主函数以及训练函数代码：</p>
<p>main.c:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;math.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdlib.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;time.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;assert.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdio.h&quot;</span> </span><br> <br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> <span class="hljs-title function_">get_row</span><span class="hljs-params">(<span class="hljs-type">char</span> *filename)</span>;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> <span class="hljs-title function_">get_col</span><span class="hljs-params">(<span class="hljs-type">char</span> *filename)</span>;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">void</span> <span class="hljs-title function_">get_two_dimension</span><span class="hljs-params">(<span class="hljs-type">char</span> *line, <span class="hljs-type">double</span> **dataset, <span class="hljs-type">char</span> *filename)</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br> <span class="hljs-type">char</span> filename[] = <span class="hljs-string">&quot;data.csv&quot;</span>;<br>    <span class="hljs-type">char</span> line[<span class="hljs-number">1024</span>];<br>    <span class="hljs-type">int</span> row = get_row(filename);<br>    <span class="hljs-type">int</span> col = get_col(filename);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;row = %d\n&quot;</span>,row);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;col = %d\n&quot;</span>,col);<br>    <span class="hljs-type">double</span> **dataset = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>(row*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span> *));<br>    <span class="hljs-type">int</span> i;<br> <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; row; ++i)&#123;<br>  dataset[i] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(col*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br> &#125;<span class="hljs-comment">//动态申请二维数组 </span><br> get_two_dimension(line, dataset, filename);<br>    <span class="hljs-type">double</span> l_rate = <span class="hljs-number">0.01</span>;<br> <span class="hljs-type">int</span> n_epoch = <span class="hljs-number">100</span>;<br> <span class="hljs-type">int</span> n_folds = <span class="hljs-number">4</span>;<br> <span class="hljs-type">int</span> fold_size;<br>    fold_size=(<span class="hljs-type">int</span>)(row/n_folds);<br> evaluate_algorithm(dataset, n_folds, fold_size, l_rate, n_epoch,col,row);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>test_prediction.c:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> innode  2       <span class="hljs-comment">//输入结点数</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> hidenode  12   <span class="hljs-comment">//隐藏结点数</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> cell_num 8  <span class="hljs-comment">//LMTM细胞数 </span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> uniform_plus_minus_one ( (double)( 2.0 * rand() ) / ((double)RAND_MAX + 1.0) - 1.0 )  <span class="hljs-comment">//均匀随机分布 </span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;math.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdlib.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;time.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;assert.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;string.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdio.h&quot;</span> </span><br><span class="hljs-comment">//激活函数</span><br><span class="hljs-type">double</span> <span class="hljs-title function_">sigmoid</span><span class="hljs-params">(<span class="hljs-type">double</span> x)</span> <br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1.0</span> / (<span class="hljs-number">1.0</span> + <span class="hljs-built_in">exp</span>(-x));<br>&#125;<br> <br><span class="hljs-comment">//激活函数的导数，y为激活函数值</span><br><span class="hljs-type">double</span> <span class="hljs-title function_">dsigmoid</span><span class="hljs-params">(<span class="hljs-type">double</span> y)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> y * (<span class="hljs-number">1.0</span> - y);  <br>&#125;           <br> <br><span class="hljs-comment">//tanh的导数，y为tanh值</span><br><span class="hljs-type">double</span> <span class="hljs-title function_">dtanh</span><span class="hljs-params">(<span class="hljs-type">double</span> y)</span><br>&#123;<br>    y = <span class="hljs-built_in">tanh</span>(y);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1.0</span> - y * y;  <br>&#125;<br> <br><span class="hljs-comment">//将一个10进制整数转换为2进制数</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">int2binary</span><span class="hljs-params">(<span class="hljs-type">int</span> n, <span class="hljs-type">int</span> *arr)</span><br>&#123;<br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span>(n)<br>    &#123;<br>        arr[i++] = n % <span class="hljs-number">2</span>;<br>        n /= <span class="hljs-number">2</span>;<br>    &#125;<br>    <span class="hljs-keyword">while</span>(i &lt; cell_num)<br>        arr[i++] = <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">//训练模型并获得预测值 </span><br><span class="hljs-type">int</span>* <span class="hljs-title function_">get_test_prediction</span><span class="hljs-params">(<span class="hljs-type">double</span> **train, <span class="hljs-type">double</span> **test, <span class="hljs-type">double</span> l_rate, <span class="hljs-type">int</span> n_epoch, <span class="hljs-type">int</span> train_size,<span class="hljs-type">int</span> test_size,<span class="hljs-type">int</span> col)</span>&#123;<br> <span class="hljs-type">int</span> epoch,i, j, k, m, p;<br> <span class="hljs-type">int</span> x[innode];<br> <span class="hljs-type">double</span> y;<br> <br> <span class="hljs-type">double</span> W_I[innode][hidenode];     <span class="hljs-comment">//连接输入与隐含层单元中输入门的权值矩阵</span><br>    <span class="hljs-type">double</span> U_I[hidenode][hidenode];   <span class="hljs-comment">//连接上一隐层输出与本隐含层单元中输入门的权值矩阵</span><br>    <span class="hljs-type">double</span> W_F[innode][hidenode];     <span class="hljs-comment">//连接输入与隐含层单元中遗忘门的权值矩阵</span><br>    <span class="hljs-type">double</span> U_F[hidenode][hidenode];   <span class="hljs-comment">//连接上一隐含层与本隐含层单元中遗忘门的权值矩阵</span><br>    <span class="hljs-type">double</span> W_O[innode][hidenode];     <span class="hljs-comment">//连接输入与隐含层单元中遗忘门的权值矩阵</span><br>    <span class="hljs-type">double</span> U_O[hidenode][hidenode];   <span class="hljs-comment">//连接上一隐含层与现在时刻的隐含层的权值矩阵</span><br>    <span class="hljs-type">double</span> W_G[innode][hidenode];     <span class="hljs-comment">//用于产生新记忆的权值矩阵</span><br>    <span class="hljs-type">double</span> U_G[hidenode][hidenode];   <span class="hljs-comment">//用于产生新记忆的权值矩阵</span><br>    <span class="hljs-type">double</span> W_out[hidenode];  <span class="hljs-comment">//连接隐层与输出层的权值矩阵</span><br>    <br>    <span class="hljs-comment">// 初始化 </span><br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;innode;i++)&#123;<br>     <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;hidenode;j++)&#123;<br>      W_I[i][j] = uniform_plus_minus_one;<br>      W_F[i][j] = uniform_plus_minus_one;<br>      W_O[i][j] = uniform_plus_minus_one;<br>      W_G[i][j] = uniform_plus_minus_one;<br>  &#125;<br> &#125;<br> <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;hidenode;i++)&#123;<br>  <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;hidenode;j++)&#123;<br>   U_I[i][j] = uniform_plus_minus_one;<br>   U_F[i][j] = uniform_plus_minus_one;<br>   U_O[i][j] = uniform_plus_minus_one;<br>   U_G[i][j] = uniform_plus_minus_one;<br>  &#125;<br>  W_out[i] = uniform_plus_minus_one;<br> &#125;<br> <br>    <span class="hljs-keyword">for</span>(epoch=<span class="hljs-number">0</span>;epoch&lt;n_epoch;epoch++)&#123;<br>     <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;train_size;i++)&#123;<br>      <span class="hljs-type">double</span> **I_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *));<br>   <span class="hljs-type">double</span> **F_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *));<br>   <span class="hljs-type">double</span> **O_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *));    <br>      <span class="hljs-type">double</span> **G_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *));      <br>      <span class="hljs-type">double</span> **M_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num+<span class="hljs-number">1</span>)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *));     <br>      <span class="hljs-type">double</span> **h_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num+<span class="hljs-number">1</span>)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *));     <br>      <span class="hljs-type">double</span> y_delta[cell_num];    <span class="hljs-comment">//保存误差关于输出层的偏导</span><br>  <br>   <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;cell_num;j++)&#123;<br>          M_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>          h_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>          I_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>          F_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>          O_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>          G_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>   &#125;<br>   M_vector[cell_num] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>      h_vector[cell_num] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br> <br>         <span class="hljs-type">int</span> predict[cell_num];     <span class="hljs-comment">//保存每次生成的预测值</span><br> <br>        <br>         <span class="hljs-type">double</span> M[hidenode];     <span class="hljs-comment">//记忆值</span><br>         <span class="hljs-type">double</span> h[hidenode];     <span class="hljs-comment">//输出值</span><br>        <br>         <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;hidenode; j++)  <br>         &#123;<br>             M[j] = <span class="hljs-number">0</span>;<br>             h[j] = <span class="hljs-number">0</span>;<br>             M_vector[<span class="hljs-number">0</span>][j] = <span class="hljs-number">0</span>;<br>          h_vector[<span class="hljs-number">0</span>][j] = <span class="hljs-number">0</span>;<br>         &#125;<br>         <br>         <span class="hljs-type">double</span> a_int = train[i][<span class="hljs-number">0</span>];<br>         <span class="hljs-type">int</span> a[cell_num];<br>         <span class="hljs-type">double</span> b_int = train[i][<span class="hljs-number">1</span>];<br>         <span class="hljs-type">int</span> b[cell_num];<br>         <span class="hljs-type">double</span> c_int = train[i][<span class="hljs-number">2</span>];<br>         <span class="hljs-type">int</span> c[cell_num];<br>         int2binary(a_int, a);<br>   int2binary(b_int, b);<br>   int2binary(c_int, c);<br>         <br>         <span class="hljs-keyword">for</span>(p=<span class="hljs-number">0</span>;p&lt;cell_num;p++)&#123;<br>       x[<span class="hljs-number">0</span>]=a[p];<br>       x[<span class="hljs-number">1</span>]=b[p];<br>       <span class="hljs-type">double</span> t = (<span class="hljs-type">double</span>)c[p];      <span class="hljs-comment">//实际值</span><br>       <span class="hljs-type">double</span> in_gate[hidenode];     <span class="hljs-comment">//输入门</span><br>             <span class="hljs-type">double</span> out_gate[hidenode];    <span class="hljs-comment">//输出门</span><br>             <span class="hljs-type">double</span> forget_gate[hidenode]; <span class="hljs-comment">//遗忘门</span><br>             <span class="hljs-type">double</span> g_gate[hidenode];      <span class="hljs-comment">//C`t </span><br>             <span class="hljs-type">double</span> memory[hidenode];       <span class="hljs-comment">//记忆值</span><br>             <span class="hljs-type">double</span> h[hidenode];           <span class="hljs-comment">//隐层输出值</span><br>             <br>             <span class="hljs-type">double</span> *h_pre = h_vector[p];<br>             <span class="hljs-type">double</span> *memory_pre = M_vector[p];<br>       <br>       <span class="hljs-keyword">for</span>(k=<span class="hljs-number">0</span>; k&lt;hidenode; k++)<br>             &#123;   <br>                 <span class="hljs-comment">//输入层转播到隐层</span><br>                 <span class="hljs-type">double</span> inGate = <span class="hljs-number">0.0</span>;<br>                 <span class="hljs-type">double</span> outGate = <span class="hljs-number">0.0</span>;<br>                 <span class="hljs-type">double</span> forgetGate = <span class="hljs-number">0.0</span>;<br>                 <span class="hljs-type">double</span> gGate = <span class="hljs-number">0.0</span>;<br>                 <span class="hljs-type">double</span> s = <span class="hljs-number">0.0</span>;<br>                 <br><br>  <br>                 <span class="hljs-keyword">for</span>(m=<span class="hljs-number">0</span>; m&lt;innode; m++) <br>                 &#123;<br>                     inGate += x[m] * W_I[m][k]; <br>                     outGate += x[m] * W_O[m][k];<br>                     forgetGate += x[m] * W_F[m][k];<br>                     gGate += x[m] * W_G[m][k];<br>                 &#125;<br>                 <br>                 <span class="hljs-keyword">for</span>(m=<span class="hljs-number">0</span>; m&lt;hidenode; m++)<br>                 &#123;<br>                     inGate += h_pre[m] * U_I[m][k];<br>                     outGate += h_pre[m] * U_O[m][k];<br>                     forgetGate += h_pre[m] * U_F[m][k];<br>                     gGate += h_pre[m] * U_G[m][k];<br>                 &#125;<br>  <br>     <br>                 in_gate[k] = sigmoid(inGate);<br>                 out_gate[k] = sigmoid(outGate);<br>                 forget_gate[k] = sigmoid(forgetGate);<br>                 g_gate[k] = sigmoid(gGate);<br>  <br>                 <span class="hljs-type">double</span> m_pre = memory_pre[k];<br>                 memory[k] = forget_gate[k] * m_pre + g_gate[k] * in_gate[k];<br>                 <br>                 h[k] = out_gate[k] * <span class="hljs-built_in">tanh</span>(memory[k]);<br>                 <br>     I_vector[p][k] = in_gate[k];<br>     F_vector[p][k] = forget_gate[k];<br>     O_vector[p][k] = out_gate[k];<br>     M_vector[p+<span class="hljs-number">1</span>][k] = memory[k];<br>     G_vector[p][k] = g_gate[k];<br>     h_vector[p+<span class="hljs-number">1</span>][k] = h[k];<br>             &#125;<br><br>             <span class="hljs-comment">//隐藏层传播到输出层</span><br>             <span class="hljs-type">double</span> out = <span class="hljs-number">0.0</span>;<br>             <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;hidenode; j++)&#123;<br>                 out += h[j] * W_out[j]; <br>    &#125;<br>             <br>             y = sigmoid(out);               <span class="hljs-comment">//输出层各单元输出</span><br>             predict[p] = <span class="hljs-built_in">floor</span>(y + <span class="hljs-number">0.5</span>);   <span class="hljs-comment">//记录预测值</span><br>             <br>    <span class="hljs-comment">//保存标准误差关于输出层的偏导</span><br>             y_delta[p] = (t - y) * dsigmoid(y);<br><br>   &#125;<br>   <span class="hljs-comment">//误差反向传播</span><br> <br>         <span class="hljs-comment">//隐含层偏差，通过当前之后一个时间点的隐含层误差和当前输出层的误差计算</span><br>         <span class="hljs-type">double</span> h_delta[hidenode];  <br>         <span class="hljs-type">double</span> O_delta[hidenode];<br>         <span class="hljs-type">double</span> I_delta[hidenode];<br>         <span class="hljs-type">double</span> F_delta[hidenode];<br>         <span class="hljs-type">double</span> G_delta[hidenode];<br>         <span class="hljs-type">double</span> memory_delta[hidenode];<br>         <span class="hljs-comment">//当前时间之后的一个隐藏层误差</span><br>         <span class="hljs-type">double</span> O_future_delta[hidenode]; <br>         <span class="hljs-type">double</span> I_future_delta[hidenode];<br>         <span class="hljs-type">double</span> F_future_delta[hidenode];<br>         <span class="hljs-type">double</span> G_future_delta[hidenode];<br>         <span class="hljs-type">double</span> memory_future_delta[hidenode];<br>         <span class="hljs-type">double</span> forget_gate_future[hidenode];<br>         <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;hidenode; j++)<br>         &#123;<br>             O_future_delta[j] = <span class="hljs-number">0.0</span>;<br>             I_future_delta[j] = <span class="hljs-number">0.0</span>;<br>             F_future_delta[j] = <span class="hljs-number">0.0</span>;<br>             G_future_delta[j] = <span class="hljs-number">0.0</span>;<br>             memory_future_delta[j] = <span class="hljs-number">0.0</span>;<br>             forget_gate_future[j] = <span class="hljs-number">0.0</span>;<br>         &#125;<br>         <br>         <span class="hljs-keyword">for</span>(p=cell_num<span class="hljs-number">-1</span>; p&gt;=<span class="hljs-number">0</span> ; p--)<br>         &#123;<br>             x[<span class="hljs-number">0</span>] = a[p];<br>             x[<span class="hljs-number">1</span>] = b[p];<br>  <br>             <span class="hljs-comment">//当前隐藏层</span><br><br>    <span class="hljs-type">double</span> in_gate[hidenode];     <span class="hljs-comment">//输入门</span><br>             <span class="hljs-type">double</span> out_gate[hidenode];    <span class="hljs-comment">//输出门</span><br>             <span class="hljs-type">double</span> forget_gate[hidenode]; <span class="hljs-comment">//遗忘门</span><br>             <span class="hljs-type">double</span> g_gate[hidenode];      <span class="hljs-comment">//C`t</span><br>             <span class="hljs-type">double</span> memory[hidenode];     <span class="hljs-comment">//记忆值</span><br>             <span class="hljs-type">double</span> h[hidenode];         <span class="hljs-comment">//隐层输出值</span><br>    <span class="hljs-keyword">for</span>(k=<span class="hljs-number">0</span>;k&lt;hidenode;k++)&#123;<br>     in_gate[k] = I_vector[p][k];<br>     out_gate[k] = O_vector[p][k];<br>     forget_gate[k] = F_vector[p][k]; <span class="hljs-comment">//遗忘门</span><br>              g_gate[k] = G_vector[p][k];      <span class="hljs-comment">//C`t </span><br>              memory[k] = M_vector[p+<span class="hljs-number">1</span>][k];     <span class="hljs-comment">//记忆值</span><br>              h[k] = h_vector[p+<span class="hljs-number">1</span>][k];         <span class="hljs-comment">//隐层输出值</span><br>    &#125;<br>             <span class="hljs-comment">//前一个隐藏层</span><br>             <span class="hljs-type">double</span> *h_pre = h_vector[p];   <br>             <span class="hljs-type">double</span> *memory_pre = M_vector[p];<br>  <br>             <span class="hljs-comment">//更新隐含层和输出层之间的连接权</span><br>             <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;hidenode; j++)&#123;<br>              W_out[j] += l_rate * y_delta[p] * h[j];  <br>    &#125;<br>                 <br>             <span class="hljs-comment">//对于网络中每个隐藏单元，计算误差项，并更新权值</span><br>             <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;hidenode; j++) <br>             &#123;<br>                 h_delta[j] = y_delta[p] * W_out[j];<br>                 <span class="hljs-keyword">for</span>(k=<span class="hljs-number">0</span>; k&lt;hidenode; k++)<br>                 &#123;<br>                     h_delta[j] += I_future_delta[k] * U_I[j][k];<br>                     h_delta[j] += F_future_delta[k] * U_F[j][k];<br>                     h_delta[j] += O_future_delta[k] * U_O[j][k];<br>                     h_delta[j] += G_future_delta[k] * U_G[j][k];<br>                 &#125;<br>  <br>                 O_delta[j] = <span class="hljs-number">0.0</span>;<br>                 I_delta[j] = <span class="hljs-number">0.0</span>;<br>                 F_delta[j] = <span class="hljs-number">0.0</span>;<br>                 G_delta[j] = <span class="hljs-number">0.0</span>;<br>                 memory_delta[j] = <span class="hljs-number">0.0</span>;<br>  <br>                 <span class="hljs-comment">//隐含层的校正误差</span><br>                 O_delta[j] = h_delta[j] * <span class="hljs-built_in">tanh</span>(memory[j]) * dsigmoid(out_gate[j]);<br>                 memory_delta[j] = h_delta[j] * out_gate[j] * dtanh(memory[j]) +<br>                                  memory_future_delta[j] * forget_gate_future[j];<br>                 F_delta[j] = memory_delta[j] * memory_pre[j] * dsigmoid(forget_gate[j]);<br>                 I_delta[j] = memory_delta[j] * g_gate[j] * dsigmoid(in_gate[j]);<br>                 G_delta[j] = memory_delta[j] * in_gate[j] * dsigmoid(g_gate[j]);<br>                 <br>                 O_future_delta[j] = O_delta[j];<br>              F_future_delta[j] = F_delta[j];<br>              I_future_delta[j] = I_delta[j];<br>              G_future_delta[j] = G_delta[j];<br>              memory_future_delta[j] = memory_delta[j];<br>              forget_gate_future[j] = forget_gate[j]; <br>  <br>                 <span class="hljs-comment">//更新前一个隐含层和现在隐含层之间的权值</span><br>                 <span class="hljs-keyword">for</span>(k=<span class="hljs-number">0</span>; k&lt;hidenode; k++)<br>                 &#123;<br>                  U_I[k][j] += l_rate * I_delta[j] * h_pre[k];<br>                     U_F[k][j] += l_rate * F_delta[j] * h_pre[k];<br>                     U_O[k][j] += l_rate * O_delta[j] * h_pre[k];<br>                     U_G[k][j] += l_rate * G_delta[j] * h_pre[k];<br>                 &#125;<br>  <br>                 <span class="hljs-comment">//更新输入层和隐含层之间的连接权</span><br>                 <span class="hljs-keyword">for</span>(k=<span class="hljs-number">0</span>; k&lt;innode; k++)<br>                 &#123;<br>                     W_I[k][j] += l_rate * I_delta[j] * x[k];<br>                     W_F[k][j] += l_rate * F_delta[j] * x[k];<br>                     W_O[k][j] += l_rate * O_delta[j] * x[k];<br>                     W_G[k][j] += l_rate * G_delta[j] * x[k];<br>                 &#125;<br>             &#125;<br>         &#125;<br>   <span class="hljs-built_in">free</span>(I_vector);<br>         <span class="hljs-built_in">free</span>(F_vector);<br>         <span class="hljs-built_in">free</span>(O_vector);<br>         <span class="hljs-built_in">free</span>(G_vector);<br>         <span class="hljs-built_in">free</span>(M_vector);<br>         <span class="hljs-built_in">free</span>(h_vector);<br>  &#125;<br> &#125;<br> <span class="hljs-type">int</span> *predictions=(<span class="hljs-type">int</span>*)<span class="hljs-built_in">malloc</span>(test_size*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br> <span class="hljs-comment">// 预测</span><br> <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;test_size;i++)&#123;<br>  <span class="hljs-type">double</span> **M_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num+<span class="hljs-number">1</span>)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *));     <br>  <span class="hljs-type">double</span> **h_vector = (<span class="hljs-type">double</span> **)<span class="hljs-built_in">malloc</span>((cell_num+<span class="hljs-number">1</span>)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span> *));<br>  <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;cell_num+<span class="hljs-number">1</span>;j++)&#123;<br>      M_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>      h_vector[j] = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(hidenode*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>  &#125;<br>  <br>  <br>  <span class="hljs-type">int</span> predict[cell_num];               <span class="hljs-comment">//保存每次生成的预测值</span><br>        <span class="hljs-comment">// memset(predict, 0, sizeof(predict));</span><br>        <br>  <span class="hljs-type">double</span> M[hidenode];     <span class="hljs-comment">//记忆值</span><br>        <span class="hljs-type">double</span> h[hidenode];     <span class="hljs-comment">//输出值</span><br>        <br>        <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;hidenode; j++)  <br>        &#123;<br>            M[j] = <span class="hljs-number">0</span>;<br>            h[j] = <span class="hljs-number">0</span>;<br>            M_vector[<span class="hljs-number">0</span>][j] = <span class="hljs-number">0</span>;<br>         h_vector[<span class="hljs-number">0</span>][j] = <span class="hljs-number">0</span>;<br>        &#125;<br><br>         <br>        <span class="hljs-type">double</span> a_int = test[i][<span class="hljs-number">0</span>];<br>        <span class="hljs-type">int</span> a[cell_num];<br>        <span class="hljs-type">double</span> b_int = test[i][<span class="hljs-number">1</span>];<br>        <span class="hljs-type">int</span> b[cell_num];<br>        <span class="hljs-type">double</span> c_int = test[i][<span class="hljs-number">2</span>];<br>        <span class="hljs-type">int</span> c[cell_num];<br><br>  int2binary(a_int, a);<br>  int2binary(b_int, b);<br>  int2binary(c_int, c);<br>        <br>         <br>        <span class="hljs-keyword">for</span>(p=<span class="hljs-number">0</span>;p&lt;cell_num;p++)&#123;<br>      x[<span class="hljs-number">0</span>]=a[p];<br>      x[<span class="hljs-number">1</span>]=b[p];<br>      <span class="hljs-type">double</span> in_gate[hidenode];     <span class="hljs-comment">//输入门</span><br>         <span class="hljs-type">double</span> out_gate[hidenode];    <span class="hljs-comment">//输出门</span><br>         <span class="hljs-type">double</span> forget_gate[hidenode]; <span class="hljs-comment">//遗忘门</span><br>         <span class="hljs-type">double</span> g_gate[hidenode];      <span class="hljs-comment">//C`t </span><br>         <span class="hljs-type">double</span> memory[hidenode];       <span class="hljs-comment">//记忆值</span><br>         <span class="hljs-type">double</span> h[hidenode];           <span class="hljs-comment">//隐层输出值</span><br>       <br>      <span class="hljs-keyword">for</span>(k=<span class="hljs-number">0</span>; k&lt;hidenode; k++)<br>         &#123;   <br>             <span class="hljs-comment">//输入层转播到隐层</span><br>             <span class="hljs-type">double</span> inGate = <span class="hljs-number">0.0</span>;<br>             <span class="hljs-type">double</span> outGate = <span class="hljs-number">0.0</span>;<br>             <span class="hljs-type">double</span> forgetGate = <span class="hljs-number">0.0</span>;<br>             <span class="hljs-type">double</span> gGate = <span class="hljs-number">0.0</span>;<br>             <span class="hljs-type">double</span> s = <span class="hljs-number">0.0</span>;<br>  <br>  <br>             <span class="hljs-type">double</span> *h_pre = h_vector[p];<br>             <span class="hljs-type">double</span> *memory_pre = M_vector[p];<br>                 <br>             <span class="hljs-keyword">for</span>(m=<span class="hljs-number">0</span>; m&lt;innode; m++) <br>             &#123;<br>                 inGate += x[m] * W_I[m][k]; <br>                 outGate += x[m] * W_O[m][k];<br>                 forgetGate += x[m] * W_F[m][k];<br>                 gGate += x[m] * W_G[m][k];<br>             &#125;<br>                 <br>             <span class="hljs-keyword">for</span>(m=<span class="hljs-number">0</span>; m&lt;hidenode; m++)<br>                &#123;<br>                    inGate += h_pre[m] * U_I[m][k];<br>                    outGate += h_pre[m] * U_O[m][k];<br>                    forgetGate += h_pre[m] * U_F[m][k];<br>                    gGate += h_pre[m] * U_G[m][k];<br>                &#125;<br>  <br> <br>             in_gate[k] = sigmoid(inGate);   <br>             out_gate[k] = sigmoid(outGate);<br>             forget_gate[k] = sigmoid(forgetGate);<br>             g_gate[k] = sigmoid(gGate);<br>  <br>             <span class="hljs-type">double</span> m_pre = memory_pre[k];<br>             memory[k] = forget_gate[k] * m_pre + g_gate[k] * in_gate[k];<br>             h[k] = out_gate[k] * <span class="hljs-built_in">tanh</span>(memory[k]);<br>             <br>             M_vector[p+<span class="hljs-number">1</span>][k] = memory[k];<br>    h_vector[p+<span class="hljs-number">1</span>][k] = h[k];<br>         &#125;<br><br>         <span class="hljs-comment">//隐藏层传播到输出层</span><br>         <span class="hljs-type">double</span> out = <span class="hljs-number">0.0</span>;<br>         <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>; j&lt;hidenode; j++)&#123;<br>             out += h[j] * W_out[j];<br>   &#125;<br>         y = sigmoid(out);     <span class="hljs-comment">//输出层各单元输出</span><br>         predict[p] = <span class="hljs-built_in">floor</span>(y + <span class="hljs-number">0.5</span>);<br>         <br>     &#125;<br>     <span class="hljs-built_in">free</span>(M_vector);<br>     <span class="hljs-built_in">free</span>(h_vector);<br>     <br>     <span class="hljs-type">int</span> out=<span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span>(k=cell_num<span class="hljs-number">-1</span>; k&gt;=<span class="hljs-number">0</span>; k--)&#123;<br>            out += predict[k] * <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, k);<br>  &#125;  <br>  predictions[i] = out;<br> &#125;<br><br> <span class="hljs-keyword">return</span> predictions;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最终输出结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">row = <span class="hljs-number">910</span><br>col = <span class="hljs-number">3</span><br>score[<span class="hljs-number">0</span>]=<span class="hljs-number">80.176211</span>%<br>score[<span class="hljs-number">1</span>]=<span class="hljs-number">100.000000</span>%<br>score[<span class="hljs-number">2</span>]=<span class="hljs-number">32.599119</span>%<br>score[<span class="hljs-number">3</span>]=<span class="hljs-number">100.000000</span>%<br>mean_accuracy=<span class="hljs-number">78.193833</span>%<br></code></pre></td></tr></table></figure>

<p>B站视频链接：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/bv1st4y1v72S">C语言实现机器学习系列教程_哔哩哔哩 (゜-゜)つロ 干杯~-bilibili</a> P22</p>
<p>github链接：<a target="_blank" rel="noopener" href="https://github.com/Gao-Jianxiong-SDUWH/C-machine-learning/tree/main/LSTM">Gao-Jianxiong-SDUWH&#x2F;C-machine-learning</a></p>

	</article>

	 
    <div class="kira-post-copyright">
        <strong>本文作者：</strong>ChocolateBlack<br>
        <strong>本文链接：</strong><a href="http://chocolateblack.club/2020/10/06/C%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0LSTM%E7%AE%97%E6%B3%95/" title="http:&#x2F;&#x2F;chocolateblack.club&#x2F;2020&#x2F;10&#x2F;06&#x2F;C语言实现LSTM算法&#x2F;" target="_blank" rel="noopener">http:&#x2F;&#x2F;chocolateblack.club&#x2F;2020&#x2F;10&#x2F;06&#x2F;C语言实现LSTM算法&#x2F;</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可
        
    </div>

  
	<div class="kira-post-nav">
		<nav class="post-nav">
			      
			<!-- 先找到与当前文字相同的目录 -->
			      
			<!-- 在找到当前文章所在的 index -->
			    
			<!-- 上一篇文章 -->
			<div class="old">
				<span>上一章</span>
				<a href="/2020/07/23/%E5%81%9A%E4%B8%80%E4%B8%AA%E4%BA%BA%E4%BD%93%E5%8A%A8%E4%BD%9C%E8%AF%86%E5%88%AB%E7%9A%84%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/"> 做一个人体动作识别的微信小程序</a>
			</div>
			       
			<!-- 下一篇文章 -->
			<div class="new">
				<span>下一章</span>
				<a href="/2021/02/01/%E6%98%8E%E6%97%A5%E6%96%B9%E8%88%9F%E7%B2%BE%E4%BA%8CBox%E6%8E%A8%E8%8D%90%E5%99%A8%EF%BC%9A%E7%BD%97%E5%BE%B7%E5%B2%9B%E4%B9%8B%E5%BF%83%EF%BC%8C%E9%A1%B9%E7%9B%AE%E5%BF%83%E5%BE%97%E4%B8%8E%E7%BB%8F%E9%AA%8C/"> 明日方舟精二Box推荐器：罗德岛之心，项目心得与经验</a>
			</div>
			                             
		</nav>
	</div>
	
	<div class="kira-post-meta kira-rainbow">
		
			<a class="kirafont icon-appstore-fill -link" href="/categories/%E6%8A%80%E6%9C%AF%E6%95%99%E7%A8%8B/">技术教程</a>
		
		
			<a class="kirafont icon-tag-fill -none-link" href="/tags/C%E8%AF%AD%E8%A8%80/" rel="tag">C语言</a> <a class="kirafont icon-tag-fill -none-link" href="/tags/LSTM/" rel="tag">LSTM</a>
		
	</div>
	
		<script src="/js/kira-code-copy.js"></script>
	
	
	<div class="kira-post-footer">
		

		
	</div>
	
</div>

				</div>
			</div>
			<div class="kira-right-column">
	<a onclick="document.querySelector('#kira-top-header').scrollIntoView({behavior: 'smooth'});" class="kira-backtotop" aria-label="回到顶部" title="回到顶部">
		<button class="mdui-fab mdui-ripple">
			<i class="kirafont icon-caret-up"></i>
		</button>
	</a>
</div>

		</div>
	</body>
</html>
